# This is a basic workflow to help you get started with Actions

name: CD

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'CLAUDE.md'
      - 'README.md'
      - '.gitignore'
      - 'LICENSE.md'
      - '.github/**'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "deploy"
  deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Hugo Setup
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 0.152.2
        extended: true

    - name: Hugo Build
      run: hugo --gc --minify --panicOnWarning

    - name: Run Integration Tests
      run: |
        echo "üß™ Running integration tests..."

        # Test 1: Verify critical files exist
        echo "üìÑ Checking critical files..."
        test -f public/index.html || { echo "‚ùå FAIL: index.html not found"; exit 1; }
        test -f public/sitemap.xml || { echo "‚ùå FAIL: sitemap.xml not found"; exit 1; }
        test -f public/robots.txt || { echo "‚ùå FAIL: robots.txt not found"; exit 1; }
        test -f public/_headers || { echo "‚ùå FAIL: _headers not found"; exit 1; }
        test -f public/_redirects || { echo "‚ùå FAIL: _redirects not found"; exit 1; }
        test -f public/js/bg.js || { echo "‚ùå FAIL: bg.js not found"; exit 1; }
        echo "‚úÖ All critical files present"

        # Test 2: Verify glucose widget HTML is present
        echo "ü©∏ Checking glucose widget..."
        if ! grep -q 'id=glucose' public/index.html; then
          echo "‚ùå FAIL: Glucose widget section not found in HTML"
          exit 1
        fi
        if ! grep -q 'id=glucose-text' public/index.html; then
          echo "‚ùå FAIL: Glucose text element not found in HTML"
          exit 1
        fi
        if ! grep -q 'Blood Glucose Stats' public/index.html; then
          echo "‚ùå FAIL: Glucose widget heading not found in HTML"
          exit 1
        fi
        echo "‚úÖ Glucose widget HTML present"

        # Test 3: Verify bg.js script is loaded
        echo "üìú Checking bg.js script inclusion..."
        if ! grep -q '<script src=/js/bg.js></script>' public/index.html; then
          echo "‚ùå FAIL: bg.js script tag not found in HTML"
          echo "This means the glucose widget won't load!"
          exit 1
        fi
        echo "‚úÖ bg.js script tag present"

        # Test 4: Verify security headers are configured
        echo "üîí Checking security headers..."
        if ! grep -q 'X-XSS-Protection' public/_headers; then
          echo "‚ùå FAIL: XSS Protection header not found"
          exit 1
        fi
        if ! grep -q 'Strict-Transport-Security' public/_headers; then
          echo "‚ùå FAIL: HSTS header not found"
          exit 1
        fi
        echo "‚úÖ Security headers configured"

        # Test 5: Verify SEO metadata
        echo "üîç Checking SEO metadata..."
        if ! grep -q 'application/ld+json' public/index.html; then
          echo "‚ùå FAIL: JSON-LD structured data not found"
          exit 1
        fi
        echo "‚úÖ SEO metadata present"

        # Test 6: Count total pages built
        TOTAL_PAGES=$(find public -name "*.html" | wc -l)
        echo "üìä Built $TOTAL_PAGES HTML pages"
        if [ "$TOTAL_PAGES" -lt 50 ]; then
          echo "‚ö†Ô∏è  WARNING: Expected more pages (got $TOTAL_PAGES)"
        fi

        echo ""
        echo "‚úÖ All integration tests passed!"

    - name: Copy frontend files to S3 with the AWS CLI
      run: |
        aws s3 sync public s3://dddiaz.com --delete

    - name: Clear Cloudfront Cache
      run: |
        aws cloudfront create-invalidation --distribution-id E15F5SGXIT0KSW --paths '/*'

    - name: Post-Deployment Integration Tests
      run: |
        echo "üåê Running post-deployment tests on live site..."
        echo "‚è≥ Waiting 30s for CloudFront invalidation to propagate..."
        sleep 30

        SITE_URL="https://www.dddiaz.com"

        # Test 1: Verify homepage loads
        echo "üè† Testing homepage..."
        HTTP_STATUS=$(curl -s -o /tmp/homepage.html -w "%{http_code}" "$SITE_URL/")
        if [ "$HTTP_STATUS" != "200" ]; then
          echo "‚ùå FAIL: Homepage returned HTTP $HTTP_STATUS (expected 200)"
          exit 1
        fi
        echo "‚úÖ Homepage loads successfully (HTTP 200)"

        # Test 2: Verify glucose widget HTML is present
        echo "ü©∏ Checking glucose widget on live site..."
        if ! grep -q 'id=glucose' /tmp/homepage.html; then
          echo "‚ùå FAIL: Glucose widget section not found in deployed HTML"
          exit 1
        fi
        if ! grep -q 'id=glucose-text' /tmp/homepage.html; then
          echo "‚ùå FAIL: Glucose text element not found in deployed HTML"
          exit 1
        fi
        echo "‚úÖ Glucose widget HTML present on live site"

        # Test 3: Verify bg.js script is loaded
        echo "üìú Checking bg.js script inclusion on live site..."
        if ! grep -q '<script src=/js/bg.js></script>' /tmp/homepage.html; then
          echo "‚ùå FAIL: bg.js script tag not found in deployed HTML"
          exit 1
        fi
        echo "‚úÖ bg.js script tag present on live site"

        # Test 4: Verify bg.js file is accessible
        echo "üì¶ Testing bg.js file accessibility..."
        BG_JS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/js/bg.js")
        if [ "$BG_JS_STATUS" != "200" ]; then
          echo "‚ùå FAIL: bg.js returned HTTP $BG_JS_STATUS (expected 200)"
          exit 1
        fi
        echo "‚úÖ bg.js file accessible (HTTP 200)"

        # Test 5: Verify sitemap is accessible
        echo "üó∫Ô∏è  Testing sitemap.xml..."
        SITEMAP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/sitemap.xml")
        if [ "$SITEMAP_STATUS" != "200" ]; then
          echo "‚ùå FAIL: sitemap.xml returned HTTP $SITEMAP_STATUS (expected 200)"
          exit 1
        fi
        echo "‚úÖ Sitemap accessible (HTTP 200)"

        # Test 6: Verify robots.txt is accessible
        echo "ü§ñ Testing robots.txt..."
        ROBOTS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/robots.txt")
        if [ "$ROBOTS_STATUS" != "200" ]; then
          echo "‚ùå FAIL: robots.txt returned HTTP $ROBOTS_STATUS (expected 200)"
          exit 1
        fi
        echo "‚úÖ robots.txt accessible (HTTP 200)"

        # Test 7: Verify SEO metadata on live site
        echo "üîç Checking SEO metadata on live site..."
        if ! grep -q 'application/ld+json' /tmp/homepage.html; then
          echo "‚ùå FAIL: JSON-LD structured data not found in deployed HTML"
          exit 1
        fi
        echo "‚úÖ SEO metadata present on live site"

        echo ""
        echo "‚úÖ All post-deployment tests passed!"
        echo "üéâ Site is live and fully functional at $SITE_URL"
